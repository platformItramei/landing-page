FROM node:20 AS builder

WORKDIR /build

# 1. Update npm to latest version to fix known bugs
RUN npm install -g npm@latest

# 2. Copy only package files first
COPY package.json package-lock.json ./

# 3. Clean install with forced optional dependencies
RUN npm ci --force

# 4. Copy source files
COPY . .

# 5. Build with specific environment variables
RUN npm run build

FROM node:20
WORKDIR /app
COPY --from=builder /build/dist ./dist
RUN npm install -g serve

ENV PORT=5174
EXPOSE 5174
CMD ["serve", "-s", "dist", "-l", "0.0.0.0:5174"]